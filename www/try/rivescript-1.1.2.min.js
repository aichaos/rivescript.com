/* rivescript 1.1.2 -- built on 2015-06-18 04:27:40 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.RiveScript=a()}}(function(){var define,module,exports;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d,e,f;f=a("./utils"),e=a("./inheritance"),d=function(){function a(a){this.master=a,this.strict=a._strict,this.utf8=a._utf8,this._currentUser=null}return a.prototype.say=function(a){return this.master.say(a)},a.prototype.warn=function(a,b,c){return this.master.warn(a,b,c)},a.prototype.reply=function(a,b,c){var d,e;return this.say("Asked to reply to ["+a+"] "+b),this._currentUser=a,b=this.formatMessage(b),e="",this.master._topics.__begin__?(d=this._getReply(a,"request","begin",0,c),d.indexOf("{ok}")>-1&&(e=this._getReply(a,b,"normal",0,c),d=d.replace(/\{ok\}/g,e)),e=d,e=this.processTags(a,b,e,[],[],0,c)):e=this._getReply(a,b,"normal",0,c),this.master._users[a].__history__.input.pop(),this.master._users[a].__history__.input.unshift(b),this.master._users[a].__history__.reply.pop(),this.master._users[a].__history__.reply.unshift(e),this._currentUser=void 0,e},a.prototype._getReply=function(a,b,c,d,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka;if(!this.master._sorted.topics)return this.warn("You forgot to call sortReplies()!"),"ERR: Replies Not Sorted";if(this.master._users[a]||(this.master._users[a]={topic:"random"}),ga=this.master._users[a].topic,da=[],ea=[],aa="",this.master._topics[ga]||(this.warn("User "+a+" was in an empty topic named '"+ga+"'"),ga=this.master._users[a].topic="random"),d>this.master._depth)return"ERR: Deep Recursion Detected";if("begin"===c&&(ga="__begin__"),this.master._users[a].__history__||(this.master._users[a].__history__={input:["undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined"],reply:["undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined"]}),!this.master._topics[ga])return"ERR: No default topic 'random' was found!";if(H=null,I=null,o=!1,0===d)for(h=[ga],(this.master._topics[ga].includes||this.master._topics[ga].inherits)&&(h=e.getTopicTree(this.master,ga)),u=0,z=h.length;z>u;u++)if(fa=h[u],this.say("Checking topic "+fa+" for any %Previous's"),this.master._sorted.thats[fa])for(this.say("There's a %Previous in this topic!"),x=this.master._users[a].__history__.reply[0],x=this.formatMessage(x,!0),this.say("Last reply: "+x),T=this.master._sorted.thats[fa],v=0,A=T.length;A>v;v++)if(ha=T[v],O=ha[0],i=this.triggerRegexp(a,O),this.say("Try to match lastReply ("+x+") to "+i),G=x.match(new RegExp("^"+i+"$")),G&&(this.say("Bot side matched!"),ea=G,ea.shift(),ia=ha[1],$=this.triggerRegexp(a,ia.trigger),this.say('Try to match "'+b+'" against '+ia.trigger+" ("+$+")"),s=f.isAtomic(ia.trigger),t=!1,s?b===$&&(t=!0):(G=b.match(new RegExp("^"+$+"$")),G&&(t=!0,da=G,da.length>=1&&da.shift())),t)){H=ia,o=!0,I=ia.trigger;break}if(!o)for(this.say("Searching their topic for a match..."),U=this.master._sorted.topics[ga],w=0,B=U.length;B>w;w++){if(ha=U[w],O=ha[0],$=this.triggerRegexp(a,O),this.say('Try to match "'+b+'" against '+O+" ("+$+")"),s=f.isAtomic(O),t=!1,s)b===$&&(t=!0);else if(G=b.match(new RegExp("^"+$+"$")),G&&(t=!0,da=[],G.length>1))for(r=F=1,V=G.length;V>=1?V>=F:F>=V;r=V>=1?++F:--F)da.push(G[r]);if(t){this.say("Found a match!"),H=ha[1],o=!0,I=O;break}}if(this.master._users[a].__lastmatch__=I,H)for(W=[1],J=0,C=W.length;C>J;J++){if(L=W[J],null!=H.redirect){this.say("Redirecting us to "+H.redirect),S=this.processTags(a,b,H.redirect,da,ea,d,g),this.say("Pretend user said: "+S),aa=this._getReply(a,S,c,d+1,g);break}for(X=H.condition,M=0,D=X.length;D>M;M++)if(ca=X[M],q=ca.split(/\s*=>\s*/),q&&2===q.length&&(l=q[0].match(/^(.+?)\s+(==|eq|!=|ne|<>|<|<=|>|>=)\s+(.*?)$/))){if(y=f.strip(l[1]),n=l[2],ba=f.strip(l[3]),P=f.strip(q[1]),y=this.processTags(a,b,y,da,ea,d,g),ba=this.processTags(a,b,ba,da,ea,d,g),0===y.length&&(y="undefined"),0===ba.length&&(ba="undefined"),this.say("Check if "+y+" "+n+" "+ba),N=!1,"eq"===n||"=="===n)y===ba&&(N=!0);else if("ne"===n||"!="===n||"<>"===n)y!==ba&&(N=!0);else try{y=parseInt(y),ba=parseInt(ba),"<"===n&&ba>y?N=!0:"<="===n&&ba>=y?N=!0:">"===n&&y>ba?N=!0:">="===n&&y>=ba&&(N=!0)}catch(la){m=la,this.warn("Failed to evaluate numeric condition!")}if(N){aa=P;break}}if(void 0!==aa&&aa.length>0)break;for(j=[],Y=H.reply,Q=0,E=Y.length;E>Q;Q++)for(_=Y[Q],ka=1,G=_.match(/\{weight=(\d+?)\}/i),G&&(ka=G[1],0>=ka&&(this.warn("Can't have a weight <= 0!"),ka=1)),r=R=0,Z=ka;Z>=0?Z>=R:R>=Z;r=Z>=0?++R:--R)j.push(_);k=parseInt(Math.random()*j.length),aa=j[k];break}if(o?(void 0===aa||0===aa.length)&&(aa="ERR: No Reply Found"):aa="ERR: No Reply Matched",this.say("Reply: "+aa),"begin"===c){for(G=aa.match(/\{topic=(.+?)\}/i),p=0;G;){if(p++,p>=50){this.warn("Infinite loop looking for topic tag!");break}K=G[1],this.master._users[a].topic=K,aa=aa.replace(new RegExp("{topic="+f.quotemeta(K)+"}","ig"),""),G=aa.match(/\{topic=(.+?)\}/i)}for(G=aa.match(/<set (.+?)=(.+?)>/i),p=0;G;){if(p++,p>=50){this.warn("Infinite loop looking for set tag!");break}K=G[1],ja=G[2],this.master._users[a][K]=ja,aa=aa.replace(new RegExp("<set "+f.quotemeta(K)+"="+f.quotemeta(ja)+">","ig"),""),G=aa.match(/<set (.+?)=(.+?)>/i)}}else aa=this.processTags(a,b,aa,da,ea,d,g);return aa},a.prototype.formatMessage=function(a,b){return a=""+a,a=a.toLowerCase(),a=this.substitute(a,"sub"),this.utf8?(a=a.replace(/[\\<>]+/,""),null!=b&&(a=a.replace(/[.?,!;:@#$%^&*()]/,""))):a=f.stripNasties(a,this.utf8),a},a.prototype.triggerRegexp=function(a,b){var c,d,e,g,h,i,j,k,l,m,n,o,p,q,r,s;for(b=b.replace(/^\*$/,"<zerowidthstar>"),b=b.replace(/\*/g,"(.+?)"),b=b.replace(/#/g,"(\\d+?)"),b=b.replace(/_/g,"(\\w+?)"),b=b.replace(/\{weight=\d+\}/g,""),b=b.replace(/<zerowidthstar>/g,"(.*?)"),this.utf8&&(b=b.replace(/\\@/,"\\u0040")),k=b.match(/\[(.+?)\]/),c=0;k;){if(c++>50)return this.warn("Infinite loop when trying to process optionals in a trigger!"),"";for(o=k[1].split("|"),m=[],e=0,i=o.length;i>e;e++)n=o[e],m.push("\\s*"+n+"\\s*");m.push("\\s*"),p=m.join("|"),p=p.replace(new RegExp(f.quotemeta("(.+?)"),"g"),"(?:.+?)"),p=p.replace(new RegExp(f.quotemeta("(\\d+?)"),"g"),"(?:\\d+?)"),p=p.replace(new RegExp(f.quotemeta("(\\w+?)"),"g"),"(?:\\w+?)"),b=b.replace(new RegExp("\\s*\\["+f.quotemeta(k[1])+"\\]\\s*"),"(?:"+p+")"),k=b.match(/\[(.+?)\]/)}for(b=b.replace(/\\w/,"[A-Za-z]"),c=0;b.indexOf("@")>-1&&!(c++>50);)k=b.match(/\@(.+?)\b/),k&&(l=k[1],r="",this.master._array[l]&&(r="(?:"+this.master._array[l].join("|")+")"),b=b.replace(new RegExp("@"+f.quotemeta(l)+"\\b"),r));for(c=0;b.indexOf("<bot")>-1&&!(c++>50);)k=b.match(/<bot (.+?)>/i),k&&(l=k[1],r="",this.master._var[l]&&(r=f.stripNasties(this.master._var[l])),b=b.replace(new RegExp("<bot "+f.quotemeta(l)+">"),r.toLowerCase()));for(c=0;b.indexOf("<get")>-1&&!(c++>50);)k=b.match(/<get (.+?)>/i),k&&(l=k[1],r="undefined","undefined"!=typeof this.master._users[a][l]&&(r=this.master._users[a][l]),b=b.replace(new RegExp("<get "+f.quotemeta(l)+">","ig"),r.toLowerCase()));for(c=0,b=b.replace(/<input>/i,"<input1>"),b=b.replace(/<reply>/i,"<reply1>");(b.indexOf("<input")>-1||b.indexOf("<reply")>-1)&&!(c++>50);)for(q=["input","reply"],g=0,j=q.length;j>g;g++)for(s=q[g],d=h=1;9>=h;d=++h)b.indexOf("<"+s+d+">")>-1&&(b=b.replace(new RegExp("<"+s+d+">","g"),this.master._users[a].__history__[s][d]));return this.utf8&&b.indexOf("\\u")>-1&&(b=b.replace(/\\u([A-Fa-f0-9]{4})/,function(a,b){return String.fromCharCode(parseInt(b,16))})),b},a.prototype.processTags=function(a,b,c,d,e,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M;for(G=[""],G.push.apply(G,d),j=[""],j.push.apply(j,e),1===G.length&&G.push("undefined"),1===j.length&&j.push("undefined"),c=c.replace(/<person>/gi,"{person}<star>{/person}"),c=c.replace(/<@>/gi,"{@<star>}"),c=c.replace(/<formal>/gi,"{formal}<star>{/formal}"),c=c.replace(/<sentence>/gi,"{sentence}<star>{/sentence}"),c=c.replace(/<uppercase>/gi,"{uppercase}<star>{/uppercase}"),c=c.replace(/<lowercase>/gi,"{lowercase}<star>{/lowercase}"),c=c.replace(/\{weight=\d+\}/gi,""),c=c.replace(/<star>/gi,G[1]),c=c.replace(/<botstar>/gi,j[1]),o=q=1,C=G.length;C>=1?C>=q:q>=C;o=C>=1?++q:--q)c=c.replace(new RegExp("<star"+o+">","ig"),G[o]);for(o=r=1,D=j.length;D>=1?D>=r:r>=D;o=D>=1?++r:--r)c=c.replace(new RegExp("<botstar"+o+">","ig"),j[o]);for(c=c.replace(/<input>/gi,this.master._users[a].__history__.input[0]),c=c.replace(/<reply>/gi,this.master._users[a].__history__.reply[0]),o=s=1;9>=s;o=++s)c.indexOf("<input"+o+">")>-1&&(c=c.replace(new RegExp("<input"+o+">","ig"),this.master._users[a].__history__.input[o])),c.indexOf("<reply"+o+">")>-1&&(c=c.replace(new RegExp("<reply"+o+">","ig"),this.master._users[a].__history__.reply[o]));for(c=c.replace(/<id>/gi,a),c=c.replace(/\\s/gi," "),c=c.replace(/\\n/gi,"\n"),c=c.replace(/\\#/gi,"#"),w=c.match(/\{random\}(.+?)\{\/random\}/i),n=0;w;){if(n++>this.master._depth){this.warn("Infinite loop looking for random tag!");break}B=[],K=w[1],B=K.indexOf("|")>-1?K.split("|"):K.split(" "),z=B[parseInt(Math.random()*B.length)],c=c.replace(new RegExp("\\{random\\}"+f.quotemeta(K)+"\\{\\/random\\}","ig"),z),w=c.match(/\{random\}(.+?)\{\/random\}/i)}for(m=["person","formal","sentence","uppercase","lowercase"],v=0,u=m.length;u>v;v++)for(L=m[v],w=c.match(new RegExp("{"+L+"}(.+?){/"+L+"}","i")),n=0;w;){if(n++,n>=50){this.warn("Infinite loop looking for "+L+" tag!");break}k=w[1],E="person"===L?this.substitute(k,"person"):f.stringFormat(L,k),c=c.replace(new RegExp("{"+L+"}"+f.quotemeta(k)+("{/"+L+"}"),"ig"),E),w=c.match(new RegExp("{"+L+"}(.+?){/"+L+"}","i"))}for(c=c.replace(/<call>/gi,"{__call__}"),c=c.replace(/<\/call>/gi,"{/__call__}");;){if(w=c.match(/<([^<]+?)>/),!w)break;w=w[1],A=w.split(" "),I=A[0].toLowerCase(),l="",A.length>1&&(l=A.slice(1).join(" ")),p="","bot"===I||"env"===I?(J="bot"===I?this.master._var:this.master._global,l.indexOf("=")>-1?(A=l.split("=",2),this.say("Set "+I+" variable "+A[0]+" = "+A[1]),J[A[0]]=A[1]):p=J[l]||"undefined"):"set"===I?(A=l.split("=",2),this.say("Set uservar "+A[0]+" = "+A[1]),this.master._users[a][A[0]]=A[1]):"add"===I||"sub"===I||"mult"===I||"div"===I?(A=l.split("="),x=A[0],M=A[1],"undefined"!=typeof this.master._users[a][x]&&(this.master._users[a][x]=0),M=parseInt(M),isNaN(M)?p="[ERR: Math can't '"+I+"' non-numeric value '"+M+"']":isNaN(parseInt(this.master._users[a][x]))?p="[ERR: Math can't '"+I+"' non-numeric user variable '"+x+"']":(F=parseInt(this.master._users[a][x]),"add"===I?F+=M:"sub"===I?F-=M:"mult"===I?F*=M:"div"===I&&(0===M?p="[ERR: Can't Divide By Zero]":F/=M),""===p&&(this.master._users[a][x]=F))):p="get"===I?this.master._users[a][l]:"\x00"+w+"",c=c.replace(new RegExp("<"+f.quotemeta(w)+">"),p)}for(c=c.replace(/\x00/g,"<"),c=c.replace(/\x01/g,">"),w=c.match(/\{topic=(.+?)\}/i),n=0;w;){if(n++,n>=50){this.warn("Infinite loop looking for topic tag!");break}x=w[1],this.master._users[a].topic=x,c=c.replace(new RegExp("{topic="+f.quotemeta(x)+"}","ig"),""),w=c.match(/\{topic=(.+?)\}/i)}for(w=c.match(/\{@(.+?)\}/),n=0;w;){if(n++,n>=50){this.warn("Infinite loop looking for redirect tag!");break}J=w[1],this.say("Inline redirection to: "+J),H=this._getReply(a,J,"normal",g+1,h),c=c.replace(new RegExp("\\{@"+f.quotemeta(J)+"\\}","i"),H),w=c.match(/\{@(.+?)\}/)}for(c=c.replace(/\{__call__\}/g,"<call>"),c=c.replace(/\{\/__call__\}/g,"</call>"),w=c.match(/<call>(.+?)<\/call>/i),n=0;w;){if(n++,n>=50){this.warn("Infinite loop looking for call tag!");break}K=f.strip(w[1]),A=K.split(/\s+/),y=A.shift(),i=A,z="",this.master._objlangs[y]?(t=this.master._objlangs[y],z=this.master._handlers[t]?this.master._handlers[t].call(this.master,y,i,h):"[ERR: No Object Handler]"):z="[ERR: Object Not Found]",c=c.replace(new RegExp("<call>"+f.quotemeta(w[1])+"</call>","i"),z),w=c.match(/<call>(.+?)<\/call>/i)}return c},a.prototype.substitute=function(a,b){var c,d,e,g,h,i,j,k,l,m,n,o,p;if(n="",!this.master._sorted[b])return this.master.warn("You forgot to call sortReplies()!"),"";for(o="sub"===b?this.master._sub:this.master._person,i=[],j=0,m=this.master._sorted[b],d=0,e=m.length;e>d;d++)h=m[d],n=o[h],l=f.quotemeta(h),i.push(n),k="\x00"+j+"\x00",j++,a=a.replace(new RegExp("^"+l+"$","g"),k),a=a.replace(new RegExp("^"+l+"(\\W+)","g"),k+"$1"),a=a.replace(new RegExp("(\\W+)"+l+"(\\W+)","g"),"$1"+k+"$2"),a=a.replace(new RegExp("(\\W+)"+l+"$","g"),"$1"+k);for(p=0;a.indexOf("\x00")>-1;){if(p++,p>50){this.warn("Too many loops in substitution placeholders!");break}g=a.match("\\x00(.+?)\\x00"),g&&(c=parseInt(g[1]),n=i[c],a=a.replace(new RegExp("\x00"+c+"\x00","g"),n))}return a},a}(),b.exports=d},{"./inheritance":2,"./utils":7}],2:[function(a,b,c){var d,e;e=function(a,b,c,d,f,g){var h,i,j,k,l,m,n,o,p,q,r,s;if(null==c&&(c=!1),null==d&&(d=0),null==f&&(f=0),null==g&&(g=0),d>a._depth)return void a.warn("Deep recursion while scanning topic inheritance!");if(a.say("Collecting trigger list for topic "+b+" (depth="+d+"; inheritance="+f+"; inherited="+g+")"),s=[],j=[],c){if(null!=a._thats[b])for(h in a._thats[b])for(p in a._thats[b][h])j.push([p,a._thats[b][h][p]])}else if(null!=a._topics[b])for(q=a._topics[b],i=0,n=q.length;n>i;i++)r=q[i],j.push([r.trigger,r]);if(Object.keys(a._includes[b]).length>0)for(k in a._includes[b])a.say("Topic "+b+" includes "+k),s.push.apply(s,e(a,k,c,d+1,f+1,!1));if(Object.keys(a._inherits[b]).length>0)for(l in a._inherits[b])a.say("Topic "+b+" inherits "+l),s.push.apply(s,e(a,l,c,d+1,f+1,!0));if(Object.keys(a._inherits[b]).length>0||g)for(m=0,o=j.length;o>m;m++)r=j[m],a.say("Prefixing trigger with {inherits="+f+"} "+r),s.push.apply(s,[["{inherits="+f+"}"+r[0],r[1]]]);else s.push.apply(s,j);return s},d=function(a,b,c){var e,f,g;if(null==c&&(c=0),c>a._depth)return a.warn("Deep recursion while scanning topic tree!"),[];g=[b];for(e in a._topics[b].includes)g.push.apply(g,d(a,e,c+1));for(f in a._topics[b].inherits)g.push.apply(g,d(a,f,c+1));return g},c.getTopicTriggers=e,c.getTopicTree=d},{}],3:[function(require,module,exports){"use strict";var JSObjectHandler;JSObjectHandler=function(){function JSObjectHandler(a){this._master=a,this._objects={}}return JSObjectHandler.prototype.load=function(name,code){var e,source;source='this._objects["'+name+'"] = function(rs, args) {\n'+code.join("\n")+"}\n";try{return eval(source)}catch(_error){return e=_error,this._master.warn("Error evaluating JavaScript object: "+e.message)}},JSObjectHandler.prototype.call=function(a,b,c,d){var e,f,g;if(!this._objects[b])return"[ERR: Object Not Found]";f=this._objects[b],g="";try{g=f.call(d,a,c)}catch(h){e=h,g="[ERR: Error when executing JavaScript object: "+e.message+"]"}return void 0===g&&(g=""),g},JSObjectHandler}(),module.exports=JSObjectHandler},{}],4:[function(a,b,c){"use strict";var d,e,f;f=a("./utils"),e="2.0",d=function(){function a(a){this.master=a,this.strict=a._strict,this.utf8=a._utf8}return a.prototype.say=function(a){return this.master.say(a)},a.prototype.warn=function(a,b,c){return this.master.warn(a,b,c)},a.prototype.parse=function(a,b,c){var d,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X;for(d={begin:{global:{},"var":{},sub:{},person:{},array:{}},topics:{},objects:[]},U="random",D=0,h=!1,o=!1,P="",O="",N=[],j=null,u="",p=null,F={concat:"none"},i={none:"",newline:"\n",space:" "},E=b.split("\n"),I=q=0,w=E.length;w>q;I=++q)if(C=E[I],D=I+1,C=f.strip(C),0!==C.length)if(o)C.indexOf("< object")>-1||C.indexOf("<object")>-1?(P.length>0&&d.objects.push({name:P,language:O,code:N}),P=O="",N=[],o=!1):N.push(C);else if(0!==C.indexOf("//"))if(0!==C.indexOf("#"))if(0!==C.indexOf("/*")){if(C.indexOf("*/")>-1)h=!1;else if(!h)if(C.length<2)this.warn("Weird single-character line '"+C+"' found.",a,D);else{for(g=C.substring(0,1),C=f.strip(C.substring(1)),C.indexOf(" // ")>-1&&(C=f.strip(C.split(" // ")[0])),S=this.checkSyntax(g,C),""!==S&&(this.strict&&"function"==typeof c?c.call(null,"Syntax error: "+S+" at "+a+" line "+D+" near "+g+" "+C):this.warn("Syntax error: "+S+" at "+a+" line "+D+" near "+g+" "+C)),"+"===g&&(p=null),this.say("Cmd: "+g+"; line: "+C),R=E.slice(I+1),B=r=0,x=R.length;x>r;B=++r)if(H=R[B],H=f.strip(H),!(H.length<2)){if(G=H.substring(0,1),H=f.strip(H.substring(1)),"%"!==G&&"^"!==G)break;if(0===H.length)break;if(this.say("	Lookahead "+B+": "+G+" "+H),"+"===g){if("%"===G){p=H;break}p=null}if("!"!==g){if("^"!==g&&"%"!==G){if("^"!==G)break;C+=void 0!==i[F.concat]?i[F.concat]+H:H}}else"^"===G&&(C+="<crlf>"+H)}switch(g){case"!":if(m=C.split("=",2),v=f.strip(m[0]).split(" "),X=V=M="",2===m.length&&(X=f.strip(m[1])),v.length>=1&&(V=f.strip(v[0]),v.length>=2&&(v.shift(),M=f.strip(v.join(" ")))),"array"!==V&&(X=X.replace(/<crlf>/g,"")),"version"===V){if(parseFloat(X)>parseFloat(e))return this.warn("Unsupported RiveScript version. We only support "+e,a,D),!1;continue}if(0===M.length){this.warn("Undefined variable name",a,D);continue}if(0===X.length){this.warn("Undefined variable value",a,D);continue}switch(V){case"local":this.say("	Set local parser option "+M+" = "+X),F[M]=X;break;case"global":this.say("	Set global "+M+" = "+X),d.begin.global[M]=X;break;case"var":this.say("	Set bot variable "+M+" = "+X),d.begin["var"][M]=X;break;case"array":if(this.say("	Set array "+M+" = "+X),"<undef>"===X){d.begin.array[M]="<undef>";continue}for(Q=X.split("<crlf>"),l=[],s=0,y=Q.length;y>s;s++)W=Q[s],W.indexOf("|")>-1?l.push.apply(l,W.split("|")):l.push.apply(l,W.split(" "));for(n=J=0,z=l.length;z>J;n=++J)k=l[n],l[n]=l[n].replace(/\\s/gi," ");d.begin.array[M]=l;break;case"sub":this.say("	Set substitution "+M+" = "+X),d.begin.sub[M]=X;break;case"person":this.say("	Set person substitution "+M+" = "+X),d.begin.person[M]=X;break;default:this.warn("Unknown definition type "+V,a,D)}break;case">":switch(T=f.strip(C).split(" "),V=T.shift(),M="",l=[],T.length>0&&(M=T.shift()),T.length>0&&(l=T),V){case"begin":case"topic":if("begin"===V&&(this.say("Found the BEGIN block."),V="topic",M="__begin__"),this.say("Set topic to "+M),j=null,U=M,this.initTopic(d.topics,U),K="",l.length>=2)for(L=0,A=l.length;A>L;L++)k=l[L],"includes"===k||"inherits"===k?K=k:""!==K&&(d.topics[U][K][k]=1);break;case"object":t="",l.length>0&&(t=l[0].toLowerCase()),""===t&&(this.warn("Trying to parse unknown programming language",a,D),t="javascript"),P=M,O=t,N=[],o=!0;break;default:this.warn("Unknown label type "+V,a,D)}break;case"<":V=C,"begin"===V||"topic"===V?(this.say("	End the topic label."),U="random"):"object"===V&&(this.say("	End the object label."),o=!1);break;case"+":this.say("	Trigger pattern: "+C),this.initTopic(d.topics,U),j={trigger:C,reply:[],condition:[],redirect:null,previous:p},d.topics[U].triggers.push(j);break;case"-":if(null===j){this.warn("Response found before trigger",a,D);continue}this.say("	Response: "+C),j.reply.push(C);break;case"*":if(null===j){this.warn("Condition found before trigger",a,D);continue}this.say("	Condition: "+C),j.condition.push(C);break;case"%":continue;case"^":continue;case"@":this.say("	Redirect response to: "+C),j.redirect=f.strip(C);break;default:this.warn("Unknown command '"+g+"'",a,D)}}}else{if(C.indexOf("*/")>-1)continue;h=!0}else this.warn("Using the # symbol for comments is deprecated",a,D);return d},a.prototype.checkSyntax=function(a,b){var c,d,e,f,g,h,i,j,k;if("!"===a){if(!b.match(/^.+(?:\s+.+|)\s*=\s*.+?$/))return"Invalid format for !Definition line: must be '! type name = value' OR '! type = value'"}else if(">"===a){if(j=b.split(/\s+/),"begin"===j[0]&&j.length>1)return"The 'begin' label takes no additional arguments";if("topic"===j[0]){if(b.match(/[^a-z0-9_\-\s]/))return"Topics should be lowercased and contain only letters and numbers"}else if("object"===j[0]&&b.match(/[^A-Za-z0-9\_\-\s]/))return"Objects can only contain numbers and letters"}else if("+"===a||"%"===a||"@"===a){if(i=k=f=c=0,this.utf8){if(b.match(/[A-Z\\.]/))return"Triggers can't contain uppercase letters, backslashes or dots in UTF-8 mode"}else if(b.match(/[^a-z0-9(|)\[\]*_#@{}<>=\s]/))return"Triggers may only contain lowercase letters, numbers, and these symbols: ( | ) [ ] * _ # { } < > =";for(e=b.split(""),g=0,h=e.length;h>g;g++)switch(d=e[g]){case"(":i++;break;case")":i--;break;case"[":k++;break;case"]":k--;break;case"{":f++;break;case"}":f--;break;case"<":c++;break;case">":c--}if(0!==i)return"Unmatched parenthesis brackets";if(0!==k)return"Unmatched square brackets";if(0!==f)return"Unmatched curly brackets";if(0!==c)return"Unmatched angle brackets"}else if("*"===a&&!b.match(/^.+?\s*(?:==|eq|!=|ne|<>|<|<=|>|>=)\s*.+?=>.+?$/))return"Invalid format for !Condition: should be like '* value symbol value => response'";return""},a.prototype.initTopic=function(a,b){return null==a[b]?a[b]={includes:{},inherits:{},triggers:[]}:void 0},a}(),b.exports=d},{"./utils":7}],5:[function(a,b,c){"use strict";var d,e,f,g,h,i,j,k;h="1.1.2",f=a("./parser"),d=a("./brain"),k=a("./utils"),j=a("./sorting"),i=a("./inheritance"),e=a("./lang/javascript"),g=function(){function c(a){null==a&&(a={}),this._debug=a.debug?a.debug:!1,this._strict=a.strict?a.strict:!0,this._depth=a.depth?parseInt(a.depth):50,this._utf8=a.utf8?a.utf8:!1,this._onDebug=a.onDebug?a.onDebug:null,this._node={},this._runtime=this.runtime(),this.parser=new f(this),this.brain=new d(this),this._pending=[],this._loadCount=0,this._global={},this._var={},this._sub={},this._person={},this._array={},this._users={},this._freeze={},this._includes={},this._inherits={},this._handlers={},this._objlangs={},this._topics={},this._thats={},this._sorted={},"object"==typeof a&&(a.debug&&(this._debug=!0),a.strict&&(this._strict=!0),a.depth&&(this._depth=parseInt(a.depth)),a.utf8&&(this._utf8=!0)),this._handlers.javascript=new e(this),this.say("RiveScript Interpreter v"+h+" Initialized."),this.say("Runtime Environment: "+this._runtime)}return c.prototype.version=function(){return h},c.prototype.runtime=function(){return"undefined"==typeof window&&"object"==typeof b?(this._node.fs=a("fs"),"node"):"web"},c.prototype.say=function(a){return this._debug===!0?this._onDebug?this._onDebug(a):console.log(a):void 0},c.prototype.warn=function(a,b,c){return null!=b&&null!=c&&(a+=" at "+b+" line "+c),this._onDebug?this._onDebug("[WARNING] "+a):console?console.error?console.error(a):console.log("[WARNING] "+a):window?window.alert(a):void 0},c.prototype.loadFile=function(a,b,c){var d,e,f,g;for("string"==typeof a&&(a=[a]),g=this._loadCount++,this._pending[g]={},e=0,f=a.length;f>e;e++)d=a[e],this.say("Request to load file: "+d),this._pending[g][d]=1,"web"===this._runtime?this._ajaxLoadFile(g,d,b,c):this._nodeLoadFile(g,d,b,c);return g},c.prototype._ajaxLoadFile=function(a,b,c,d){return $.ajax({url:b,dataType:"text",success:function(e){return function(f,g,h){return e.say("Loading file "+b+" complete."),e.parse(b,f,d),delete e._pending[a][b],0===Object.keys(e._pending[a]).length&&"function"==typeof c?c.call(void 0,a):void 0}}(this),error:function(b){return function(c,e,f){return b.say("Ajax error! "+e+"; "+f),"function"==typeof d?d.call(void 0,e,a):void 0}}(this)})},c.prototype._nodeLoadFile=function(a,b,c,d){return this._node.fs.readFile(b,function(e){return function(f,g){return f?void("function"==typeof d?d.call(void 0,f,a):e.warn(f)):(e.parse(b,""+g,d),delete e._pending[a][b],0===Object.keys(e._pending[a]).length&&"function"==typeof c?c.call(void 0,a):void 0)}}(this))},c.prototype.loadDirectory=function(a,b,c){var d;return"web"===this._runtime?void this.warn("loadDirectory can't be used on the web!"):(d=this._loadCount++,this._pending[d]={},this.say("Loading batch "+d+" from directory "+a),this._node.fs.readdir(a,function(e){return function(f,g){var h,i,j,k,l,m,n;if(f)return void("function"==typeof c?c.call(void 0,f):e.warn(f));for(n=[],i=0,k=g.length;k>i;i++)h=g[i],h.match(/\.(rive|rs)$/i)&&(e._pending[d][a+"/"+h]=1,n.push(a+"/"+h));for(m=[],j=0,l=n.length;l>j;j++)h=n[j],e.say("Parsing file "+h+" from directory"),m.push(e._nodeLoadFile(d,h,b,c));return m}}(this)))},c.prototype.stream=function(a,b){return this.say("Streaming code."),this.parse("stream()",a,b)},c.prototype.parse=function(a,b,c){var d,e,f,g,h,i,j,l,m,n,o,p,q,r,s,t,u,v,w;this.say("Parsing code!"),d=this.parser.parse(a,b,c),n=d.begin;for(u in n){w=n[u],g="_"+u;for(l in w)v=w[l],"<undef>"===v?delete this[g][l]:this[g][l]=v}o=d.topics;for(s in o)for(e=o[s],null==this._includes[s]&&(this._includes[s]={}),null==this._inherits[s]&&(this._inherits[s]={}),k.extend(this._includes[s],e.includes),k.extend(this._inherits[s],e.inherits),null==this._topics[s]&&(this._topics[s]=[]),p=e.triggers,f=0,i=p.length;i>f;f++)t=p[f],this._topics[s].push(t),null!=t.previous&&(null==this._thats[s]&&(this._thats[s]={}),null==this._thats[s][t.trigger]&&(this._thats[s][t.trigger]={}),this._thats[s][t.trigger][t.previous]=t);for(q=d.objects,r=[],h=0,j=q.length;j>h;h++)m=q[h],this._handlers[m.language]?(this._objlangs[m.name]=m.language,r.push(this._handlers[m.language].load(m.name,m.code))):r.push(void 0);return r},c.prototype.sortReplies=function(){var a,b,c;this._sorted.topics={},this._sorted.thats={},this.say("Sorting triggers...");for(c in this._topics)this.say("Analyzing topic "+c+"..."),a=i.getTopicTriggers(this,c),this._sorted.topics[c]=j.sortTriggerSet(a,!0),b=i.getTopicTriggers(this,c,!0),this._sorted.thats[c]=j.sortTriggerSet(b,!1);return this._sorted.sub=j.sortList(Object.keys(this._sub)),this._sorted.person=j.sortList(Object.keys(this._person))},c.prototype.setHandler=function(a,b){return void 0===b?delete this._handlers[a]:this._handlers[a]=b},c.prototype.setSubroutine=function(a,b){return this._handlers.javascript?(this._objlangs[a]="javascript",this._handlers.javascript.load(a,b)):void 0},c.prototype.setGlobal=function(a,b){return void 0===b?delete this._global[a]:this._global[a]=b},c.prototype.setVariable=function(a,b){return void 0===b?delete this._var[a]:this._var[a]=b},c.prototype.setSubstitution=function(a,b){return void 0===b?delete this._sub[a]:this._sub[a]=b},c.prototype.setPerson=function(a,b){return void 0===b?delete this._person[a]:this._person[a]=b},c.prototype.setUservar=function(a,b,c){return this._users[a]||(this._users[a]={topic:"random"}),void 0===c?delete this._users[a][b]:this._users[a][b]=c},c.prototype.setUservars=function(a,b){var c,d;this._users[a]||(this._users[a]={topic:"random"}),d=[];for(c in b)void 0===b[c]?d.push(delete this._users[a][c]):d.push(this._users[a][c]=b[c]);return d},c.prototype.getVariable=function(a,b){return"undefined"!=typeof this._var[b]?this._var[b]:"undefined"},c.prototype.getUservar=function(a,b){return this._users[a]&&"undefined"!=typeof this._users[a][b]?this._users[a][b]:"undefined"},c.prototype.getUservars=function(a){return void 0===a?k.clone(this._users):null!=this._users[a]?k.clone(this._users[a]):void 0},c.prototype.clearUservars=function(a){return void 0===a?this._users={}:delete this._users[a]},c.prototype.freezeUservars=function(a){return null!=this._users[a]?this._freeze[a]=k.clone(this._users[a]):this.warn("Can't freeze vars for user "+a+": not found!")},c.prototype.thawUservars=function(a,b){return null==b&&(b="thaw"),"string"!=typeof b&&(b="thaw"),null==this._freeze[a]?void this.warn("Can't thaw user vars: "+a+" wasn't frozen!"):"thaw"===b?(this.clearUservars(a),this._users[a]=k.clone(this._freeze[a]),delete this._freeze[a]):"discard"===b?delete this._freeze[a]:"keep"===b?(this.clearUservars(a),this._users[a]=k.clone(this._freeze[a])):this.warn("Unsupported thaw action!")},c.prototype.lastMatch=function(a){return null!=this._users[a]?this._users[a].__lastmatch__:void 0},c.prototype.currentUser=function(){return void 0===this.brain._currentUser&&this.warn("currentUser() is intended to be called from within a JS object macro!"),this.brain._currentUser},c.prototype.reply=function(a,b,c){return this.brain.reply(a,b,c)},c}(),b.exports=g},{"./brain":1,"./inheritance":2,"./lang/javascript":3,"./parser":4,"./sorting":6,"./utils":7,fs:8}],6:[function(a,b,c){var d,e;e=a("./utils"),c.sortTriggerSet=function(a,b,c){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N;for(null==c&&(c=function(a){}),null==b&&(b=!0),B={0:[]},h=0,p=a.length;p>h;h++)K=a[h],b&&null!=K[1].previous||(w=K[0].match(/\{weight=(\d+)\}/i),M=0,w&&w[1]&&(M=w[1]),null==B[M]&&(B[M]=[]),B[M].push(K));for(F=[],C=Object.keys(B).sort(function(a,b){return b-a}),k=0,q=C.length;q>k;k++){for(y=C[k],c("Sorting triggers with priority "+y),i=-1,g=-1,I={},I[i]=d(),D=B[y],l=0,r=D.length;r>l;l++)K=D[l],z=K[0],c("Looking at trigger: "+z),w=z.match(/\{inherits=(\d+)\}/i),w?(i=parseInt(w[1]),i>g&&(g=i),c("Trigger belongs to a topic that inherits other topics. Level="+i),z=z.replace(/\{inherits=\d+\}/gi,""),K[0]=z):i=-1,null==I[i]&&(I[i]=d()),z.indexOf("_")>-1?(f=e.word_count(z),c("Has a _ wildcard with "+f+" words."),f>0?(null==I[i].alpha[f]&&(I[i].alpha[f]=[]),I[i].alpha[f].push(K)):I[i].under.push(K)):z.indexOf("#")>-1?(f=e.word_count(z),c("Has a # wildcard with "+f+" words."),f>0?(null==I[i].number[f]&&(I[i].number[f]=[]),I[i].number[f].push(K)):I[i].pound.push(K)):z.indexOf("*")>-1?(f=e.word_count(z),c("Has a * wildcard with "+f+" words."),f>0?(null==I[i].wild[f]&&(I[i].wild[f]=[]),I[i].wild[f].push(K)):I[i].star.push(K)):z.indexOf("[")>-1?(f=e.word_count(z),c("Has optionals with "+f+" words."),null==I[i].option[f]&&(I[i].option[f]=[]),I[i].option[f].push(K)):(f=e.word_count(z),c("Totally atomic trigger with "+f+" words."),null==I[i].atomic[f]&&(I[i].atomic[f]=[]),I[i].atomic[f].push(K));for(I[g+1]=I[-1],delete I[-1],J=Object.keys(I).sort(function(a,b){return a-b}),o=0,s=J.length;s>o;o++){for(j=J[o],c("ip="+j),E=["atomic","option","alpha","number","wild"],v=0,t=E.length;t>v;v++)for(m=E[v],n=Object.keys(I[j][m]).sort(function(a,b){return b-a}),x=0,u=n.length;u>x;x++)N=n[x],G=I[j][m][N].sort(function(a,b){return b.length-a.length}),F.push.apply(F,G);L=I[j].under.sort(function(a,b){return b.length-a.length}),A=I[j].pound.sort(function(a,b){return b.length-a.length}),H=I[j].star.sort(function(a,b){return b.length-a.length}),F.push.apply(F,L),F.push.apply(F,A),F.push.apply(F,H)}}return F},c.sortList=function(a){var b,c,d,f,g,h,i,j,k,l,m;for(m={},f=0,i=a.length;i>f;f++)g=a[f],c=e.word_count(g,!0),null==m[c]&&(m[c]=[]),m[c].push(g);for(k=[],l=Object.keys(m).sort(function(a,b){return b-a}),h=0,j=l.length;j>h;h++)d=l[h],b=m[d].sort(function(a,b){return b.length-a.length}),k.push.apply(k,b);return k},d=function(){return{atomic:{},option:{},alpha:{},number:{},wild:{},pound:[],under:[],star:[]}}},{"./utils":7}],7:[function(a,b,c){c.strip=function(a){return a=a.replace(/^[\s\t]+/,"").replace(/[\s\t]+$/,"").replace(/[\x0D\x0A]+/,"")},c.extend=function(a,b){var c,d,e;d=[];for(c in b)e=b[c],a[c]=e;return d},c.word_count=function(a,b){var c,d,e,f,g;for(g=[],g=b?a.split(/\s+/):a.split(/[\s\*\#\_\|]+/),e=0,c=0,d=g.length;d>c;c++)f=g[c],f.length>0&&e++;return e},c.stripNasties=function(a,b){return a=b?a.replace(/[\\<>]+/g,""):a.replace(/[^A-Za-z0-9 ]/g,"")},c.quotemeta=function(a){var b,c,d,e;for(e="\\.+*?[^]$(){}=!<>|:".split(""),c=0,d=e.length;d>c;c++)b=e[c],a=a.replace(new RegExp("\\"+b,"g"),"\\"+b);return a},c.isAtomic=function(a){var b,c,d,e;for(d=["*","#","_","(","[","<"],b=0,c=d.length;c>b;b++)if(e=d[b],a.indexOf(e)>-1)return!1;return!0},c.stringFormat=function(a,b){var c,d,e,f,g,h;if("uppercase"===a)return b.toUpperCase();if("lowercase"===a)return b.toLowerCase();if("sentence"===a)return b+="",
c=b.charAt(0).toUpperCase(),c+b.substring(1);if("formal"===a){for(h=b.split(/\s+/),f=[],d=0,e=h.length;e>d;d++)g=h[d],c=g.charAt(0).toUpperCase(),f.push(c+g.substring(1));return f.join(" ")}return content},c.clone=function(a){var b,d;if(null===a||"object"!=typeof a)return a;b=a.constructor();for(d in a)b[d]=c.clone(a[d]);return b}},{}],8:[function(a,b,c){},{}]},{},[5])(5)});